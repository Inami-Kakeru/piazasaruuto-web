<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>ぴあざさるうと｜オンライン予約</title>
  <meta name="description" content="ぴあざさるうとのオンライン予約システム。簡単・便利な予約で、あなたのスタイルをサポートします。" />
  <meta name="format-detection" content="telephone=no" />

  <script src="../components/component-loader.js"></script>
  <script src="../config.js"></script>
  <style>
    /* Reset and Base Styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #d4c5b9;
      --secondary: #a8c9a8;
      --dark: #5c4b3e;
      --white: #fff;
      --black: #000;
      --gray: #666;
      --border: #ccc;
      --light-gray: #f5f5f5;
      --success: #10b981;
      --error: #ef4444;
    }

    html, body {
      height: 100%;
    }

    body {
      font-family: 'Noto Sans JP', 'Helvetica Neue', Arial, sans-serif;
      line-height: 1.6;
      color: var(--dark);
      background-color: var(--white);
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 0 20px;
    }

    /* Header */
    header {
      background-color: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      box-shadow: 0 2px 20px rgba(92, 75, 62, 0.1);
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      transition: all 0.3s ease;
    }

    .nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 0;
      max-width: 1200px;
      margin: 0 auto;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      text-decoration: none;
      color: inherit;
    }

    .brand-logo {
      width: 32px;
      height: 32px;
      border-radius: 10px;
      background: var(--primary);
      box-shadow: 0 2px 8px rgba(92, 75, 62, 0.15);
    }

    .brand-name {
      font-family: 'Noto Serif JP', serif;
      font-size: 24px;
      font-weight: 400;
      letter-spacing: 3px;
      color: var(--dark);
      transition: color 0.3s ease;
    }

    .brand-name:hover {
      color: var(--primary);
    }

    .nav-links {
      display: flex;
      list-style: none;
      gap: 20px;
      margin: 0;
      padding: 0;
    }

    .nav-links a {
      text-decoration: none;
      color: var(--dark);
      font-family: 'Noto Sans JP', sans-serif;
      font-weight: 500;
      font-size: 18px;
      letter-spacing: 1px;
      transition: all 0.3s ease;
      position: relative;
      padding: 12px 16px;
      border-radius: 8px;
    }

    .nav-links a:hover {
      color: var(--secondary);
      background-color: rgba(168, 201, 168, 0.1);
      transform: translateY(-1px);
    }

    .nav-links a::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 0;
      height: 2px;
      background-color: var(--secondary);
      transition: width 0.3s ease;
    }

    .nav-links a:hover::after {
      width: 100%;
    }

    /* Buttons */
    .btn {
      display: inline-block;
      padding: 12px 24px;
      border-radius: 8px;
      border: none;
      font-weight: 600;
      font-size: 16px;
      text-decoration: none;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Noto Sans JP', sans-serif;
      letter-spacing: 1px;
      text-align: center;
    }

    .btn-primary {
      background-color: var(--primary);
      color: var(--dark);
    }

    .btn-primary:hover {
      background-color: var(--secondary);
      transform: translateY(-2px);
    }

    .btn-secondary {
      background-color: var(--light-gray);
      color: var(--dark);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background-color: var(--border);
    }

    .btn-success {
      background-color: var(--success);
      color: var(--white);
    }

    .btn-success:hover {
      background-color: #059669;
      transform: translateY(-2px);
    }

    .btn-outline {
      background-color: transparent;
      color: var(--dark);
      border: 2px solid var(--primary);
    }

    .btn-outline:hover {
      background-color: var(--primary);
      color: var(--dark);
    }

    /* Main Content */
    main {
      padding-top: 140px;
      min-height: calc(100vh - 140px);
    }

    /* Back Button */
    .back-section {
      text-align: left;
      margin-bottom: 30px;
    }

    .back-btn {
      background: none;
      border: none;
      color: var(--gray);
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 0;
      font-family: inherit;
    }

    .back-btn:hover {
      color: var(--dark);
    }

    /* Page Title */
    .page-title {
      text-align: center;
      margin-bottom: 40px;
    }

    .page-title h1 {
      font-family: 'Noto Serif JP', serif;
      font-size: 32px;
      font-weight: 600;
      color: var(--dark);
      margin-bottom: 16px;
    }

    .title-divider {
      width: 60px;
      height: 3px;
      background-color: var(--primary);
      margin: 0 auto;
      border-radius: 2px;
    }

    /* Progress Steps */
    .progress-steps {
      display: flex;
      justify-content: space-between;
      margin-bottom: 40px;
      position: relative;
    }

    .progress-steps::before {
      content: '';
      position: absolute;
      top: 20px;
      left: 0;
      right: 0;
      height: 2px;
      background-color: var(--border);
      z-index: 1;
    }

    .step {
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      z-index: 2;
      flex: 1;
    }

    .step-circle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: var(--white);
      border: 2px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: var(--gray);
      margin-bottom: 8px;
      transition: all 0.3s ease;
    }

    .step.active .step-circle {
      background-color: var(--primary);
      border-color: var(--primary);
      color: var(--dark);
    }

    .step.completed .step-circle {
      background-color: var(--success);
      border-color: var(--success);
      color: var(--white);
    }

    .step-label {
      font-size: 12px;
      color: var(--gray);
      text-align: center;
      font-weight: 500;
    }

    .step.active .step-label {
      color: var(--dark);
    }

    .step.completed .step-label {
      color: var(--success);
    }

    /* Form Sections */
    .form-section {
      background-color: var(--white);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 4px 16px rgba(92, 75, 62, 0.08);
    }

    .section-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--dark);
      margin-bottom: 20px;
      text-align: center;
    }

    /* Menu Selection */
    .menu-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .menu-item {
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
    }

    .menu-item:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
    }

    .menu-item.selected {
      border-color: var(--primary);
      background-color: rgba(212, 197, 185, 0.1);
    }

    .menu-name {
      font-size: 18px;
      font-weight: 600;
      color: var(--dark);
      margin-bottom: 8px;
    }

    .menu-price {
      font-size: 24px;
      font-weight: 700;
      color: var(--secondary);
      margin-bottom: 8px;
    }

    .menu-duration {
      font-size: 14px;
      color: var(--gray);
    }

    /* Custom Calendar Widget */
    .cal-widget-container {
      margin: 40px 0 30px 0;
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      background-color: var(--white);
      padding: 30px;
    }

    .calendar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .calendar-nav-btn {
      background: none;
      border: none;
      font-size: 24px;
      color: var(--dark);
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      transition: all 0.3s ease;
    }

    .calendar-nav-btn:hover {
      background-color: var(--light-gray);
      color: var(--primary);
    }

    .calendar-header h3 {
      margin: 0;
      color: var(--dark);
      font-size: 18px;
      font-weight: 600;
    }

    .calendar-weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
      margin-bottom: 10px;
    }

    .weekday {
      text-align: center;
      padding: 10px;
      font-weight: 600;
      color: var(--gray);
      font-size: 14px;
      background-color: var(--light-gray);
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
      background-color: var(--border);
    }

    .calendar-day {
      background-color: var(--white);
      padding: 15px 10px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      min-height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .calendar-day:hover {
      background-color: var(--light-gray);
    }

    .calendar-day.other-month {
      color: var(--border);
      background-color: #fafafa;
    }

    .calendar-day.today {
      background-color: var(--primary);
      color: var(--white);
      font-weight: 600;
    }

    .calendar-day.selected {
      background-color: var(--secondary);
      color: var(--white);
      font-weight: 600;
    }

    .calendar-day.available {
      border: 2px solid var(--secondary);
    }

    .calendar-day.unavailable {
      background-color: #f5f5f5;
      color: var(--border);
      cursor: not-allowed;
    }

    .time-slots {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid var(--border);
    }

    .time-slots h4 {
      margin-bottom: 15px;
      color: var(--dark);
      text-align: center;
    }

    .time-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 10px;
    }

    .time-slot {
      padding: 12px;
      text-align: center;
      border: 2px solid var(--border);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      background-color: var(--white);
    }

    .time-slot:hover {
      border-color: var(--primary);
      background-color: rgba(212, 197, 185, 0.1);
    }

    .time-slot.selected {
      border-color: var(--secondary);
      background-color: var(--secondary);
      color: var(--white);
    }

    .time-slot.unavailable {
      background-color: #f5f5f5;
      color: var(--border);
      cursor: not-allowed;
      border-color: var(--border);
      opacity: 0.5;
    }
    
    .time-slot[style*="display: none"] {
      display: none !important;
    }

    /* Selected Date Time Display */
    .selected-datetime {
      background-color: rgba(168, 201, 168, 0.1);
      border: 2px solid var(--secondary);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 30px;
      text-align: center;
    }

    .selected-datetime h3 {
      color: var(--dark);
      margin-bottom: 15px;
      font-size: 18px;
    }

    .datetime-info {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .datetime-item {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .datetime-item .label {
      font-weight: 600;
      color: var(--dark);
      font-size: 14px;
    }

    .datetime-item .value {
      color: var(--secondary);
      font-size: 18px;
      font-weight: 600;
    }

    /* Responsive adjustments for calendar widget */
    @media (max-width: 768px) {
      .datetime-info {
        grid-template-columns: 1fr;
        gap: 15px;
      }
      
      .cal-widget-container {
        padding: 15px;
      }
      
      .calendar-day {
        padding: 10px 5px;
        min-height: 50px;
        font-size: 14px;
      }
      
      .time-grid {
        grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
        gap: 8px;
      }
      
      .time-slot {
        padding: 10px 8px;
        font-size: 14px;
      }
    }

    /* Staff Selection */
    .staff-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .staff-item {
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
    }

    .staff-item:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
    }

    .staff-item.selected {
      border-color: var(--primary);
      background-color: rgba(212, 197, 185, 0.1);
    }

    .staff-name {
      font-size: 18px;
      font-weight: 600;
      color: var(--dark);
      margin-bottom: 8px;
    }

    .staff-specialties {
      font-size: 14px;
      color: var(--gray);
    }

    /* Customer Info Form */
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .form-group.full-width {
      grid-column: 1 / -1;
    }

    .form-group label {
      font-weight: 600;
      color: var(--dark);
    }

    .form-group input, .form-group textarea {
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 16px;
      font-family: inherit;
    }

    .form-group input:focus, .form-group textarea:focus {
      outline: none;
      border-color: var(--primary);
    }

    .form-group textarea {
      resize: vertical;
      min-height: 100px;
    }

    /* Confirmation */
    .confirmation-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 0;
      border-bottom: 1px solid var(--border);
    }

    .confirmation-item:last-child {
      border-bottom: none;
    }

    .confirmation-label {
      font-weight: 600;
      color: var(--dark);
    }

    .confirmation-value {
      color: var(--gray);
    }

    /* Navigation */
    .form-navigation {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 40px;
    }

    .nav-btn {
      min-width: 120px;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .container {
        padding: 0 15px;
      }
      
      .nav {
        padding: 15px 0;
      }
      
      .nav-links {
        display: none;
      }
      
      .brand-name {
        font-size: 20px;
        letter-spacing: 2px;
      }
      
      main {
        padding-top: 100px;
      }
      
      .form-section {
        padding: 20px;
      }
      
      .form-row {
        grid-template-columns: 1fr;
        gap: 15px;
      }
      
      .progress-steps {
        flex-direction: column;
        gap: 20px;
      }
      
      .progress-steps::before {
        display: none;
      }
      
      .step {
        flex-direction: row;
        gap: 15px;
        text-align: left;
      }
      
      .step-circle {
        margin-bottom: 0;
      }
    }
  </style>
</head>
<body>
  <!-- Header Component -->
  <div data-component="header"></div>

  <main class="container">
    <!-- Back Button -->
    <div class="back-section">
      <button class="back-btn" onclick="goBack()">
        ← ホームに戻る
      </button>
    </div>

    <!-- Page Title -->
    <div class="page-title">
      <h1>オンライン予約</h1>
      <div class="title-divider"></div>
    </div>

    <!-- Progress Steps -->
    <div class="progress-steps">
      <div class="step active" id="step1">
        <div class="step-circle">1</div>
        <div class="step-label">メニュー選択</div>
      </div>
      <div class="step" id="step2">
        <div class="step-circle">2</div>
        <div class="step-label">日時選択</div>
      </div>
      <div class="step" id="step3">
        <div class="step-circle">3</div>
        <div class="step-label">スタッフ選択</div>
      </div>
      <div class="step" id="step4">
        <div class="step-circle">4</div>
        <div class="step-label">お客様情報</div>
      </div>
      <div class="step" id="step5">
        <div class="step-circle">5</div>
        <div class="step-label">確認</div>
      </div>
    </div>

    <!-- Step 1: Menu Selection -->
    <div class="form-section" id="menuSection">
      <h2 class="section-title">メニューを選択してください</h2>
      <div class="menu-grid">
        <div class="menu-item" data-menu="cut">
          <div class="menu-name">カット</div>
          <div class="menu-price">¥3,500</div>
          <div class="menu-duration">約60分</div>
        </div>
        <div class="menu-item" data-menu="cut-color">
          <div class="menu-name">カット + カラー</div>
          <div class="menu-price">¥8,500</div>
          <div class="menu-duration">約90分</div>
        </div>
        <div class="menu-item" data-menu="cut-perm">
          <div class="menu-name">カット + パーマ</div>
          <div class="menu-price">¥10,500</div>
          <div class="menu-duration">約150分</div>
        </div>
        <div class="menu-item" data-menu="treatment">
          <div class="menu-name">トリートメント</div>
          <div class="menu-price">¥3,500</div>
          <div class="menu-duration">約45分</div>
        </div>
      </div>
      <div class="form-navigation">
        <div></div>
        <button class="btn btn-primary nav-btn" onclick="nextStep()">次へ</button>
      </div>
    </div>

    <!-- Step 2: Date Time Selection -->
    <div class="form-section" id="dateTimeSection" style="display: none;">
      <h2 class="section-title">日時を選択してください</h2>
      
      <!-- Custom Calendar Widget -->
      <div class="cal-widget-container">
        <div class="calendar-header">
          <button class="calendar-nav-btn" onclick="previousMonth()">‹</button>
          <h3 id="currentMonthYear">2024年1月</h3>
          <button class="calendar-nav-btn" onclick="nextMonth()">›</button>
        </div>
        
        <div class="calendar-weekdays">
          <div class="weekday">日</div>
          <div class="weekday">月</div>
          <div class="weekday">火</div>
          <div class="weekday">水</div>
          <div class="weekday">木</div>
          <div class="weekday">金</div>
          <div class="weekday">土</div>
        </div>
        
        <div class="calendar-grid" id="calendarGrid">
          <!-- Calendar days will be generated here -->
        </div>
        
        <div class="time-slots" id="timeSlots" style="display: none;">
          <h4>利用可能な時間</h4>
          <div class="time-grid" id="timeGrid">
            <!-- Time slots will be generated here -->
          </div>
        </div>
      </div>
      
      <!-- Selected Date Time Display -->
      <div class="selected-datetime" id="selectedDateTime" style="display: none;">
        <h3>選択された日時</h3>
        <div class="datetime-info">
          <div class="datetime-item">
            <span class="label">日付:</span>
            <span class="value" id="selectedDate">-</span>
          </div>
          <div class="datetime-item">
            <span class="label">時間:</span>
            <span class="value" id="selectedTime">-</span>
          </div>
        </div>
      </div>
      
      <div class="form-navigation">
        <button class="btn btn-secondary nav-btn" onclick="prevStep()">戻る</button>
        <button class="btn btn-primary nav-btn" onclick="nextStep()" id="nextStepBtn" disabled>次へ</button>
      </div>
    </div>

    <!-- Step 3: Staff Selection -->
    <div class="form-section" id="staffSection" style="display: none;">
      <h2 class="section-title">スタッフを選択してください</h2>
      <div class="staff-grid">
        <div class="staff-item" data-staff="tanaka">
          <div class="staff-name">田中 美香</div>
          <div class="staff-specialties">カット・カラー専門</div>
        </div>
        <div class="staff-item" data-staff="sato">
          <div class="staff-name">佐藤 雄太</div>
          <div class="staff-specialties">パーマ・カラー専門</div>
        </div>
        <div class="staff-item" data-staff="yamamoto">
          <div class="staff-name">山本 恵子</div>
          <div class="staff-specialties">カット・トリートメント専門</div>
        </div>
      </div>
      <div class="form-navigation">
        <button class="btn btn-secondary nav-btn" onclick="prevStep()">戻る</button>
        <button class="btn btn-primary nav-btn" onclick="nextStep()">次へ</button>
      </div>
    </div>

    <!-- Step 4: Customer Information -->
    <div class="form-section" id="customerSection" style="display: none;">
      <h2 class="section-title">お客様情報を入力してください</h2>
      <div class="form-row">
        <div class="form-group">
          <label for="name">お名前 *</label>
          <input type="text" id="name" required>
        </div>
        <div class="form-group">
          <label for="phone">電話番号 *</label>
          <input type="tel" id="phone" required>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="email">メールアドレス</label>
          <input type="email" id="email">
        </div>
        <div class="form-group">
          <label for="age">年齢</label>
          <input type="number" id="age" min="1" max="120">
        </div>
      </div>
      <div class="form-group full-width">
        <label for="notes">ご要望・ご質問</label>
        <textarea id="notes" placeholder="髪の長さ、希望するスタイル、アレルギーなど、お気軽にお書きください"></textarea>
      </div>
      <div class="form-navigation">
        <button class="btn btn-secondary nav-btn" onclick="prevStep()">戻る</button>
        <button class="btn btn-primary nav-btn" onclick="nextStep()">次へ</button>
      </div>
    </div>

    <!-- Step 5: Confirmation -->
    <div class="form-section" id="confirmationSection" style="display: none;">
      <h2 class="section-title">予約内容の確認</h2>
      <div class="confirmation-item">
        <span class="confirmation-label">選択メニュー</span>
        <span class="confirmation-value" id="confirmMenu">-</span>
      </div>
      <div class="confirmation-item">
        <span class="confirmation-label">予約日時</span>
        <span class="confirmation-value" id="confirmDateTime">-</span>
      </div>
      <div class="confirmation-item">
        <span class="confirmation-label">担当スタッフ</span>
        <span class="confirmation-value" id="confirmStaff">-</span>
      </div>
      <div class="confirmation-item">
        <span class="confirmation-label">お客様名</span>
        <span class="confirmation-value" id="confirmName">-</span>
      </div>
      <div class="confirmation-item">
        <span class="confirmation-label">電話番号</span>
        <span class="confirmation-value" id="confirmPhone">-</span>
      </div>
      <div class="form-navigation">
        <button class="btn btn-secondary nav-btn" onclick="prevStep()">戻る</button>
        <button class="btn btn-success nav-btn" onclick="submitBooking()">予約を確定する</button>
      </div>
    </div>
  </main>

  <script>
    let currentStep = 1;
    let bookingData = {};

    // Cal.com API Configuration
    const CAL_API_CONFIG = {
      base: window.CAL_CONFIG?.CAL_API_BASE || 'https://api.cal.com',
      key: window.CAL_CONFIG?.CAL_API_KEY || 'cal_test_xxxxxxxxxxxxxxxxxxxxxxxxx',
      version: window.CAL_CONFIG?.CAL_API_VERSION || 'v2',
      eventTypeId: window.CAL_CONFIG?.EVENT_TYPE_ID || '稲見駆-7zb7cf/15min'
    };

    // Calendar variables
    let currentDate = new Date();
    let selectedDate = null;
    let selectedTime = null;
    let availableSlots = [];

    // Initialize calendar
    document.addEventListener('DOMContentLoaded', function() {
      renderCalendar();
      generateTimeSlots();
      
      // Load environment variables if available
      loadEnvironmentVariables();
    });

    // Load environment variables from .env (if accessible)
    async function loadEnvironmentVariables() {
      try {
        // Try to load from a config endpoint or use default values
        const response = await fetch('/api/config');
        if (response.ok) {
          const config = await response.json();
          Object.assign(CAL_API_CONFIG, config);
        }
      } catch (error) {
        console.log('Using default Cal.com API configuration');
      }
    }

    // Fetch available slots from Cal.com API
    async function fetchAvailableSlots(date) {
      try {
        const formattedDate = date.toISOString().split('T')[0];
        const url = `${CAL_API_CONFIG.base}/${CAL_API_CONFIG.version}/availability?dateFrom=${formattedDate}&dateTo=${formattedDate}&eventTypeId=${CAL_API_CONFIG.eventTypeId}`;
        
        const response = await fetch(url, {
          headers: {
            'Authorization': `Bearer ${CAL_API_CONFIG.key}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          const data = await response.json();
          return data.availableSlots || [];
        } else {
          console.error('Failed to fetch available slots:', response.statusText);
          return [];
        }
      } catch (error) {
        console.error('Error fetching available slots:', error);
        // Fallback to simulated availability
        return generateSimulatedSlots(date);
      }
    }

    // Generate simulated slots for fallback
    function generateSimulatedSlots(date) {
      const dayOfWeek = date.getDay();
      const slots = [];
      
      // Business hours: 10:00-17:30 (Mon, Tue, Wed, Fri, Sat)
      if (dayOfWeek !== 0 && dayOfWeek !== 4) {
        for (let hour = 10; hour <= 17; hour++) {
          if (hour === 12) continue; // Skip lunch hour
          slots.push(`${hour.toString().padStart(2, '0')}:00`);
          if (hour < 17) {
            slots.push(`${hour.toString().padStart(2, '0')}:30`);
          }
        }
      }
      
      console.log('Generated simulated slots for', date.toDateString(), ':', slots);
      return slots;
    }

    // Render calendar
    function renderCalendar() {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      
      // Update header
      document.getElementById('currentMonthYear').textContent = 
        `${year}年${month + 1}月`;
      
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const startDate = new Date(firstDay);
      startDate.setDate(startDate.getDate() - firstDay.getDay());
      
      const calendarGrid = document.getElementById('calendarGrid');
      calendarGrid.innerHTML = '';
      
      // Generate calendar days
      for (let i = 0; i < 42; i++) {
        const date = new Date(startDate);
        date.setDate(startDate.getDate() + i);
        
        const dayElement = document.createElement('div');
        dayElement.className = 'calendar-day';
        dayElement.textContent = date.getDate();
        
        // Check if it's current month
        if (date.getMonth() !== month) {
          dayElement.classList.add('other-month');
        }
        
        // Check if it's today
        const today = new Date();
        if (date.toDateString() === today.toDateString()) {
          dayElement.classList.add('today');
        }
        
        // Check availability (simulate Cal.com API call)
        if (isDateAvailable(date)) {
          dayElement.classList.add('available');
          dayElement.addEventListener('click', () => selectDate(date));
        } else {
          dayElement.classList.add('unavailable');
        }
        
        calendarGrid.appendChild(dayElement);
      }
    }

    // Check if date is available (simulate Cal.com API)
    function isDateAvailable(date) {
      const today = new Date();
      const dayOfWeek = date.getDay();
      
      // Business logic: Available on Mon, Tue, Wed, Fri, Sat (not Sun, Thu)
      if (dayOfWeek === 0 || dayOfWeek === 4) return false;
      
      // Not available in the past
      if (date < today) return false;
      
      // Simulate some unavailable dates
      const unavailableDates = [
        '2024-01-15', '2024-01-22', '2024-02-05', '2024-02-12'
      ];
      
      return !unavailableDates.includes(date.toISOString().split('T')[0]);
    }

    // Select date
    async function selectDate(date) {
      // Remove previous selection
      document.querySelectorAll('.calendar-day.selected').forEach(day => {
        day.classList.remove('selected');
      });
      
      // Add selection to clicked day
      event.target.classList.add('selected');
      
      selectedDate = date;
      document.getElementById('selectedDate').textContent = formatDate(date.toISOString());
      
      // Show time slots
      document.getElementById('timeSlots').style.display = 'block';
      
      // Fetch available slots from Cal.com API
      availableSlots = await fetchAvailableSlots(date);
      
      // デバッグ用：取得したスロットを確認
      console.log('Fetched available slots:', availableSlots);
      
      // Update time slots availability
      updateTimeSlots(date);
      
      updateSelectedDateTime();
    }

    // Generate time slots
    function generateTimeSlots() {
      const timeGrid = document.getElementById('timeGrid');
      const times = [
        '10:00', '10:30', '11:00', '11:30', '12:00', '12:30',
        '13:00', '13:30', '14:00', '14:30', '15:00', '15:30',
        '16:00', '16:30', '17:00'
      ];
      
      timeGrid.innerHTML = '';
      
      times.forEach(time => {
        const timeSlot = document.createElement('div');
        timeSlot.className = 'time-slot';
        timeSlot.textContent = time;
        timeSlot.addEventListener('click', () => selectTime(time));
        timeSlot.style.display = 'none'; // 初期状態では非表示
        timeGrid.appendChild(timeSlot);
      });
    }

    // Update time slots availability
    function updateTimeSlots(date) {
      const timeSlots = document.querySelectorAll('.time-slot');
      
      timeSlots.forEach(slot => {
        const time = slot.textContent;
        slot.classList.remove('selected', 'unavailable');
        
        // Check if time is available from API data
        if (availableSlots.includes(time)) {
          slot.style.display = 'block';
          slot.classList.remove('unavailable');
          slot.style.cursor = 'pointer';
        } else {
          slot.style.display = 'none';
          slot.classList.add('unavailable');
          slot.style.cursor = 'not-allowed';
        }
      });
      
      // デバッグ用：利用可能な時間をコンソールに出力
      console.log('Available slots for', date.toDateString(), ':', availableSlots);
    }

    // Check if time is available
    function isTimeAvailable(date, time) {
      // Simulate Cal.com API availability check
      const hour = parseInt(time.split(':')[0]);
      
      // Business hours: 10:00-17:30
      if (hour < 10 || hour > 17) return false;
      
      // Simulate some unavailable times
      const unavailableTimes = [
        '12:00', '12:30', '13:00' // Lunch break
      ];
      
      return !unavailableTimes.includes(time);
    }

    // Select time
    function selectTime(time) {
      // Remove previous selection
      document.querySelectorAll('.time-slot.selected').forEach(slot => {
        slot.classList.remove('selected');
      });
      
      // Add selection to clicked time
      event.target.classList.add('selected');
      
      selectedTime = time;
      document.getElementById('selectedTime').textContent = time;
      
      console.log('Selected time:', time);
      updateSelectedDateTime();
    }

    // Navigation functions
    function previousMonth() {
      currentDate.setMonth(currentDate.getMonth() - 1);
      renderCalendar();
    }

    function nextMonth() {
      currentDate.setMonth(currentDate.getMonth() + 1);
      renderCalendar();
    }

    // Update selected date time display
    function updateSelectedDateTime() {
      if (selectedDate && selectedTime) {
        document.getElementById('selectedDateTime').style.display = 'block';
        document.getElementById('nextStepBtn').disabled = false;
        
        // Update booking data
        bookingData.date = selectedDate.toISOString().split('T')[0];
        bookingData.time = selectedTime;
      } else {
        document.getElementById('selectedDateTime').style.display = 'none';
        document.getElementById('nextStepBtn').disabled = true;
      }
    }

    // Format date for display
    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('ja-JP', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        weekday: 'long'
      });
    }

    // メニュー選択
    document.querySelectorAll('.menu-item').forEach(item => {
      item.addEventListener('click', function() {
        document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('selected'));
        this.classList.add('selected');
        bookingData.menu = this.dataset.menu;
        bookingData.menuName = this.querySelector('.menu-name').textContent;
        bookingData.menuPrice = this.querySelector('.menu-price').textContent;
        bookingData.menuDuration = this.querySelector('.menu-duration').textContent;
      });
    });

    // スタッフ選択
    document.querySelectorAll('.staff-item').forEach(item => {
      item.addEventListener('click', function() {
        document.querySelectorAll('.staff-item').forEach(i => i.classList.remove('selected'));
        this.classList.add('selected');
        bookingData.staff = this.dataset.staff;
        bookingData.staffName = this.querySelector('.staff-name').textContent;
      });
    });

    // 次のステップへ
    function nextStep() {
      if (currentStep === 1 && !bookingData.menu) {
        alert('メニューを選択してください');
        return;
      }
      if (currentStep === 2 && (!bookingData.date || !bookingData.time)) {
        alert('日時を選択してください');
        return;
      }
      if (currentStep === 3 && !bookingData.staff) {
        alert('スタッフを選択してください');
        return;
      }
      if (currentStep === 4) {
        if (!document.getElementById('name').value || !document.getElementById('phone').value) {
          alert('必須項目を入力してください');
          return;
        }
        // 確認データを設定
        updateConfirmation();
      }

      if (currentStep < 5) {
        currentStep++;
        updateStepDisplay();
      }
    }

    // 前のステップへ
    function prevStep() {
      if (currentStep > 1) {
        currentStep--;
        updateStepDisplay();
      }
    }

    // ステップ表示の更新
    function updateStepDisplay() {
      // すべてのセクションを非表示
      document.querySelectorAll('.form-section').forEach(section => {
        section.style.display = 'none';
      });

      // 現在のステップのセクションを表示
      const sections = ['menuSection', 'dateTimeSection', 'staffSection', 'customerSection', 'confirmationSection'];
      document.getElementById(sections[currentStep - 1]).style.display = 'block';

      // プログレスバーの更新
      updateProgressSteps();
    }

    // プログレスステップの更新
    function updateProgressSteps() {
      document.querySelectorAll('.step').forEach((step, index) => {
        step.classList.remove('active', 'completed');
        if (index + 1 < currentStep) {
          step.classList.add('completed');
        } else if (index + 1 === currentStep) {
          step.classList.add('active');
        }
      });
    }

    // 確認データの更新
    function updateConfirmation() {
      const name = document.getElementById('name').value;
      const phone = document.getElementById('phone').value;

      document.getElementById('confirmMenu').textContent = bookingData.menuName;
      document.getElementById('confirmDateTime').textContent = `${bookingData.date} ${bookingData.time}`;
      document.getElementById('confirmStaff').textContent = bookingData.staffName;
      document.getElementById('confirmName').textContent = name;
      document.getElementById('confirmPhone').textContent = phone;

      // 予約データに追加
      bookingData.customerName = name;
      bookingData.customerPhone = phone;
      bookingData.customerEmail = document.getElementById('email').value;
      bookingData.customerAge = document.getElementById('age').value;
      bookingData.notes = document.getElementById('notes').value;
    }

        // 予約送信
    async function submitBooking() {
      try {
        // Cal.comに予約を作成
        const bookingResult = await createCalBooking();
        
        if (bookingResult.success) {
          alert('予約が完了しました！\n\nご予約ありがとうございます。\n担当者より確認のご連絡をさせていただきます。');
          
          // 予約データをコンソールに出力（デバッグ用）
          console.log('Booking Data:', bookingData);
          console.log('Cal.com Booking ID:', bookingResult.bookingId);
          
          // ホームページに戻る
          window.location.href = '/';
        } else {
          alert('予約の作成に失敗しました。\n\nエラー: ' + bookingResult.error + '\n\n再度お試しください。');
        }
      } catch (error) {
        console.error('Booking error:', error);
        alert('予約の作成中にエラーが発生しました。\n\n再度お試しください。');
      }
    }

    // Cal.comに予約を作成
    async function createCalBooking() {
      try {
        const bookingData = {
          eventTypeId: CAL_API_CONFIG.eventTypeId,
          startTime: `${bookingData.date}T${bookingData.time}:00`,
          endTime: calculateEndTime(bookingData.date, bookingData.time, bookingData.menuDuration),
          attendee: {
            name: bookingData.customerName,
            email: bookingData.customerEmail || 'no-email@example.com',
            phone: bookingData.customerPhone
          },
          notes: `メニュー: ${bookingData.menuName}\nスタッフ: ${bookingData.staffName}\nご要望: ${bookingData.notes || 'なし'}`
        };

        const response = await fetch(`${CAL_API_CONFIG.base}/${CAL_API_CONFIG.version}/bookings`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${CAL_API_CONFIG.key}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(bookingData)
        });

        if (response.ok) {
          const result = await response.json();
          return {
            success: true,
            bookingId: result.id
          };
        } else {
          const errorData = await response.json();
          return {
            success: false,
            error: errorData.message || '予約の作成に失敗しました'
          };
        }
      } catch (error) {
        console.error('Cal.com booking error:', error);
        return {
          success: false,
          error: 'ネットワークエラーが発生しました'
        };
      }
    }

    // 終了時間を計算
    function calculateEndTime(date, startTime, duration) {
      const start = new Date(`${date}T${startTime}:00`);
      const durationMinutes = parseInt(duration.match(/\d+/)[0]);
      const end = new Date(start.getTime() + durationMinutes * 60000);
      
      return end.toISOString().slice(0, 16).replace('T', ' ');
    }

    // 戻るボタン
    function goBack() {
      window.location.href = '/';
    }
  </script>
</body>
</html>
