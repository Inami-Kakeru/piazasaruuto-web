# äºˆç´„ã‚·ã‚¹ãƒ†ãƒ ä»•æ§˜æ›¸

## ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦

ã´ã‚ã–ã•ã‚‹ã†ã¨äºˆç´„ã‚·ã‚¹ãƒ†ãƒ ã¯ã€Cal.com API v2ã‚’åˆ©ç”¨ã—ãŸç¾å®¹é™¢äºˆç´„ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚
5ã‚¹ãƒ†ãƒƒãƒ—ã®äºˆç´„ãƒ•ãƒ­ãƒ¼ã§ã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼é¸æŠã‹ã‚‰äºˆç´„å®Œäº†ã¾ã§ã‚’ç®¡ç†ã—ã¾ã™ã€‚

## äºˆç´„ãƒ•ãƒ­ãƒ¼

### 1. ãƒ¡ãƒ‹ãƒ¥ãƒ¼é¸æŠ (`/booking/menu`)
**å…¥åŠ›**: ãªã—  
**å‡ºåŠ›**: ãƒ¡ãƒ‹ãƒ¥ãƒ¼é¸æŠç”»é¢  
**é·ç§»**: `/booking/date?menu=<key>&menuName=<name>`

**ãƒ¡ãƒ‹ãƒ¥ãƒ¼å®šç¾©**:
```typescript
const MENUS = [
  { key: 'cut', name: 'ã‚«ãƒƒãƒˆ', price: 'Â¥3,500', duration: 'ç´„60åˆ†' },
  { key: 'cut-color', name: 'ã‚«ãƒƒãƒˆ + ã‚«ãƒ©ãƒ¼', price: 'Â¥8,500', duration: 'ç´„90åˆ†' },
  { key: 'cut-perm', name: 'ã‚«ãƒƒãƒˆ + ãƒ‘ãƒ¼ãƒ', price: 'Â¥10,500', duration: 'ç´„150åˆ†' },
  { key: 'treatment', name: 'ãƒˆãƒªãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆ', price: 'Â¥3,500', duration: 'ç´„45åˆ†' },
];
```

### 2. æ—¥æ™‚é¸æŠ (`/booking/date`)
**å…¥åŠ›**: 
- `menu`: ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚­ãƒ¼
- `menuName`: ãƒ¡ãƒ‹ãƒ¥ãƒ¼å

**APIå‘¼ã³å‡ºã—**:
```
GET /api/cal/slots?menu=<key>&date=YYYY-MM-DD&timeZone=Asia/Tokyo
```

**å‡ºåŠ›**: ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤º + ç©ºãæ™‚é–“é¸æŠ  
**é·ç§»**: `/booking/info?menu=<key>&menuName=<name>&date=YYYY-MM-DD&start=<ISO>&end=<ISO>`

**ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«**:
- æ—¥æ›œãƒ»æœ¨æ›œã¯ä¼‘æ¥­æ—¥
- éå»ã®æ—¥ä»˜ã¯é¸æŠä¸å¯
- é¸æŠã—ãŸæ—¥ä»˜ã®ç©ºãæ™‚é–“ã‚’APIã§å–å¾—

### 3. ãŠå®¢æ§˜æƒ…å ±å…¥åŠ› (`/booking/info`)
**å…¥åŠ›**:
- `menu`: ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚­ãƒ¼
- `menuName`: ãƒ¡ãƒ‹ãƒ¥ãƒ¼å
- `date`: æ—¥ä»˜ (YYYY-MM-DD)
- `start`: é–‹å§‹æ™‚é–“ (ISO)
- `end`: çµ‚äº†æ™‚é–“ (ISO)

**å‡ºåŠ›**: ãŠå®¢æ§˜æƒ…å ±å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ   
**é·ç§»**: `/booking/confirm?menu=<key>&menuName=<name>&date=...&start=...&end=...&name=...&email=...&phone=...`

**å…¥åŠ›é …ç›®**:
- ãŠåå‰ (å¿…é ˆ)
- ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ (å¿…é ˆ)
- é›»è©±ç•ªå· (ä»»æ„)

### 4. ç¢ºèª (`/booking/confirm`)
**å…¥åŠ›**:
- `menu`: ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚­ãƒ¼
- `menuName`: ãƒ¡ãƒ‹ãƒ¥ãƒ¼å
- `date`: æ—¥ä»˜
- `start`: é–‹å§‹æ™‚é–“
- `end`: çµ‚äº†æ™‚é–“
- `name`: ãŠåå‰
- `email`: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
- `phone`: é›»è©±ç•ªå·

**APIå‘¼ã³å‡ºã—**:
```
POST /api/cal/bookings
{
  menu: string,
  start: string (ISO),
  end?: string (ISO),
  timeZone: "Asia/Tokyo",
  name: string,
  email: string,
  phone?: string
}
```

**å‡ºåŠ›**: äºˆç´„å†…å®¹ç¢ºèªç”»é¢  
**é·ç§»**: `/booking/complete?uid=<bookingId>&menu=<key>&menuName=<name>&start=...&end=...&name=...&phone=...&email=...`

### 5. å®Œäº† (`/booking/complete`)
**å…¥åŠ›**:
- `uid`: äºˆç´„ID
- `menu`: ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚­ãƒ¼
- `menuName`: ãƒ¡ãƒ‹ãƒ¥ãƒ¼å
- `start`: é–‹å§‹æ™‚é–“
- `name`: ãŠåå‰
- `email`: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
- `phone`: é›»è©±ç•ªå·

**å‡ºåŠ›**: äºˆç´„å®Œäº†ç”»é¢

## APIä»•æ§˜æ›¸ï¼ˆå®Ÿè£…æº–æ‹ ç‰ˆï¼‰

### ã‚¹ãƒ­ãƒƒãƒˆé–¢é€£ API

#### GET /api/cal/slots

ğŸ“¤ **ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**
- ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿:
  - `menu` (æ¨å¥¨): ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚­ãƒ¼
  - `date` (æ¨å¥¨): YYYY-MM-DDå½¢å¼ã®æ—¥ä»˜
  - `start` (ä»»æ„): ISOå½¢å¼ã®é–‹å§‹æ™‚é–“
  - `end` (ä»»æ„): ISOå½¢å¼ã®çµ‚äº†æ™‚é–“
  - `timeZone` (ä»»æ„): ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: Asia/Tokyoï¼‰

ğŸ“¥ **ãƒ¬ã‚¹ãƒãƒ³ã‚¹**
```json
{
  "status": "success",
  "eventTypeId": number,
  "timeZone": string,
  "range": {
    "start": string,
    "end": string
  },
  "slots": [
    {
      "start": string,
      "end": string
    }
  ],
  "data": {
    "YYYY-MM-DD": [
      {
        "start": string,
        "end": string
      }
    ]
  },
  "raw": object
}
```

**ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
```json
{
  "routeId": "slots/list",
  "error": string,
  "details": {
    "eventTypeId": number,
    "sent": {
      "start": string,
      "end": string,
      "timeZone": string
    },
    "triedEndpoints": [
      {
        "url": string,
        "status": number
      }
    ]
  }
}
```

**å®Ÿè£…è©³ç´°**:
- Cal.com API v2/v1ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½ä»˜ã
- 3ã¤ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’é †æ¬¡è©¦è¡Œ:
  1. `/v2/slots?eventTypeId=&start=&end=&timeZone=`
  2. `/v2/event-types/:id/slots?start=&end=&timeZone=&format=range`
  3. `/v1/slots?eventTypeId=&startTime=&endTime=&timeZone=`
- ã‚µãƒ¼ãƒ“ã‚¹æ™‚é–“ã®è‡ªå‹•è¨ˆç®—ï¼ˆ`start`ã®ã¿ã®å ´åˆã€`end`ã‚’è‡ªå‹•ç”Ÿæˆï¼‰

#### POST /api/cal/slots/reserve

ğŸ“¤ **ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**
```json
{
  "menu": string,
  "start": string (ISO),
  "end": string (ISO),
  "timeZone": string
}
```

ğŸ“¥ **ãƒ¬ã‚¹ãƒãƒ³ã‚¹**
```json
{
  "status": "success",
  "data": {
    "reservationUid": string,
    "eventTypeId": number,
    "timeZone": string,
    "start": string,
    "end": string
  }
}
```

**å®Ÿè£…è©³ç´°**:
- ã‚½ãƒ•ãƒˆä»®æŠ¼ã•ãˆï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç”¨nonceç™ºè¡Œï¼‰
- Cal.com APIã¸ã®å®Ÿéš›ã®å‘¼ã³å‡ºã—ã¯è¡Œã‚ãªã„
- äºˆç´„æ™‚ï¼ˆ`/api/cal/bookings`ï¼‰ã§ç«¶åˆæ¤œçŸ¥

### äºˆç´„é–¢é€£ API

#### GET /api/cal/bookings

ğŸ“¤ **ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**: ãªã—

ğŸ“¥ **ãƒ¬ã‚¹ãƒãƒ³ã‚¹**
```json
{
  "ok": true,
  "where": "/api/cal/bookings"
}
```

#### POST /api/cal/bookings

ğŸ“¤ **ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**
```json
{
  "menu": string,
  "start": string (ISO),
  "end": string (ISO),
  "timeZone": string,
  "name": string,
  "email": string,
  "phone": string,
  "reservationUid": string
}
```

ğŸ“¥ **ãƒ¬ã‚¹ãƒãƒ³ã‚¹**
```json
{
  "uid": string,
  "start": string,
  "end": string,
  "attendee": {
    "name": string,
    "email": string,
    "timeZone": string,
    "language": string,
    "phoneNumber": string
  },
  "metadata": {
    "menu": string,
    "phone": string
  }
}
```

**ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
```json
{
  "routeId": "bookings/create",
  "error": string,
  "details": {
    "url": string,
    "sent": {
      "eventTypeId": number,
      "start": string,
      "timeZone": string,
      "hasReservationUid": boolean
    },
    "status": number
  }
}
```

**å®Ÿè£…è©³ç´°**:
- Cal.com API v2 `/bookings` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½¿ç”¨
- ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å¤‰æ›ï¼ˆ+09:00 â†’ UTCï¼‰
- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã«ãƒ¡ãƒ‹ãƒ¥ãƒ¼æƒ…å ±ã‚’ä¿å­˜

#### GET /api/cal/bookings/[uid]

ğŸ“¤ **ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**
- ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿: `uid` (äºˆç´„ã®UID)

ğŸ“¥ **ãƒ¬ã‚¹ãƒãƒ³ã‚¹**
```json
{
  // Cal.com APIã‹ã‚‰ã®äºˆç´„è©³ç´°ãƒ‡ãƒ¼ã‚¿ï¼ˆãã®ã¾ã¾è¿”å´ï¼‰
}
```

**ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
```json
{
  "error": "uid missing"
}
```

**å®Ÿè£…è©³ç´°**:
- Cal.com API v2 `/bookings/:uid` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½¿ç”¨
- ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¯Cal.com APIã®å½¢å¼ã‚’ãã®ã¾ã¾è¿”å´

#### POST /api/cal/bookings/cancel

ğŸ“¤ **ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**
```json
{
  "uid": string,
  "reason": string,
  "cancelSubsequent": boolean,
  "seatUid": string
}
```

ğŸ“¥ **ãƒ¬ã‚¹ãƒãƒ³ã‚¹**
```json
{
  // Cal.com APIã‹ã‚‰ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«çµæœï¼ˆãã®ã¾ã¾è¿”å´ï¼‰
}
```

**ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
```json
{
  "error": "uid is required (booking uid)"
}
```

**å®Ÿè£…è©³ç´°**:
- Cal.com API v2 `/bookings/:uid/cancel` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½¿ç”¨
- ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®é©åˆ‡ãªå‡¦ç†

### Webhook API

#### POST /api/cal/webhook

ğŸ“¤ **ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**
```json
{
  "event": string,
  "data": object
}
```

ğŸ“¥ **ãƒ¬ã‚¹ãƒãƒ³ã‚¹**
```json
{
  "ok": true
}
```

**ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
```json
{
  "error": "invalid json"
}
```

**å®Ÿè£…è©³ç´°**:
- ç½²åæ¤œè¨¼æ©Ÿèƒ½ã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼ˆå®Ÿè£…å¯èƒ½ï¼‰
- é–‹ç™ºç”¨ãƒ­ã‚°å‡ºåŠ›
- å°†æ¥çš„ãªDBæ›´æ–°ãƒ»é€šçŸ¥å‡¦ç†ã®æº–å‚™

### ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ API

#### GET /api/health

ğŸ“¤ **ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**: ãªã—

ğŸ“¥ **ãƒ¬ã‚¹ãƒãƒ³ã‚¹**
```json
{
  "ok": boolean,
  "where": "/api/health"
}
```

**å®Ÿè£…è©³ç´°**:
- å¿…é ˆç’°å¢ƒå¤‰æ•°ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
- `CAL_BASE_URL`, `CAL_API_KEY`, `CAL_EVENT_TYPE_ID` ã®ç¢ºèª
- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰: 200ï¼ˆæ­£å¸¸ï¼‰ã¾ãŸã¯ 500ï¼ˆç•°å¸¸ï¼‰

## ç’°å¢ƒå¤‰æ•°

### å¿…é ˆ
- `CAL_API_KEY`: Cal.com APIã‚­ãƒ¼
- `CAL_BASE_URL`: Cal.com APIã®ãƒ™ãƒ¼ã‚¹URLï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: https://api.cal.comï¼‰

### æ¨å¥¨
- `CAL_DEFAULT_TZ`: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: Asia/Tokyoï¼‰
- `CAL_API_VERSION`: Cal.com APIãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 2024-09-04ï¼‰

### ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¨­å®šï¼ˆã„ãšã‚Œã‹ï¼‰
- `CAL_MENU_MAP`: JSONå½¢å¼ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼â†’ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—IDãƒãƒƒãƒ—
  ```
  {"cut":3120867,"cut-color":3120869,"cut-perm":3120870,"treatment":3120871}
  ```
- `CAL_EVENT_TYPE_ID`: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ID
- å€‹åˆ¥ç’°å¢ƒå¤‰æ•°:
  - `CAL_EVT_CUT`
  - `CAL_EVT_CUT_COLOR`
  - `CAL_EVT_CUT_PERM`
  - `CAL_EVT_TREATMENT`

### ã‚µãƒ¼ãƒ“ã‚¹æ™‚é–“è¨­å®šï¼ˆã„ãšã‚Œã‹ï¼‰
- `CAL_LENGTH_MAP`: JSONå½¢å¼ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼â†’æ™‚é–“ï¼ˆåˆ†ï¼‰ãƒãƒƒãƒ—
  ```
  {"cut":60,"cut-color":90,"cut-perm":150,"treatment":45}
  ```
- `CAL_LENGTH_DEFAULT_MIN`: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚µãƒ¼ãƒ“ã‚¹æ™‚é–“ï¼ˆåˆ†ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 20ï¼‰

### ã‚ªãƒ—ã‚·ãƒ§ãƒ³
- `CAL_WEBHOOK_SECRET`: Webhookç½²åæ¤œè¨¼ç”¨ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ

## ä»Šå¾Œã®ã‚¹ãƒ†ãƒƒãƒ—

### 1. å®Ÿè£…å®Œäº†é …ç›®
- âœ… äºˆç´„ãƒ•ãƒ­ãƒ¼å…¨ä½“ã®å®Ÿè£…
- âœ… Cal.com API v2é€£æº
- âœ… ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- âœ… ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³

### 2. æ”¹å–„é …ç›®
- ğŸ”„ APIä»•æ§˜æ›¸ã®æ›´æ–°ï¼ˆå®Ÿéš›ã®å®Ÿè£…ã«åˆã‚ã›ã‚‹ï¼‰
- ğŸ”„ ç’°å¢ƒå¤‰æ•°ã®æ•´ç†ã¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆåŒ–
- ğŸ”„ ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®çµ±ä¸€

### 3. è¿½åŠ æ©Ÿèƒ½æ¤œè¨
- ğŸ“‹ äºˆç´„å¤‰æ›´æ©Ÿèƒ½
- ğŸ“‹ äºˆç´„ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ©Ÿèƒ½ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼‰
- ğŸ“‹ äºˆç´„å±¥æ­´è¡¨ç¤º
- ğŸ“‹ ãƒ¡ãƒ¼ãƒ«é€šçŸ¥æ©Ÿèƒ½
- ğŸ“‹ ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰

### 4. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–
- ğŸ”’ URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ã®æ©Ÿå¯†æƒ…å ±é€ä¿¡ã®è¦‹ç›´ã—
- ğŸ”’ ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã®æ”¹å–„
- ğŸ”’ CSRFå¯¾ç­–ã®å®Ÿè£…

### 5. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–
- âš¡ ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ã®æ¤œè¨
- âš¡ ç”»åƒæœ€é©åŒ–
- âš¡ ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºã®æœ€é©åŒ–
